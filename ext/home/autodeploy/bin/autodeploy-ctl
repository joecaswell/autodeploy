#!/usr/bin/env bash

if [[ $(whoami) != 'autodeploy' ]]
then
  echo "[error] must be started as autodeploy user $(id)" 1>&2
  exit 1
fi

export HOME=/home/autodeploy
export AUTODEPLOY=/home/autodeploy/autodeploy

cd $HOME || {
  echo "could not cd to $HOME" 1>&2
  exit 1
}

PIDFILE=/var/run/autodeploy/autodeploy.pid
LOGFILE=/var/log/autodeploy/autodeploy.log

case $1 in
  start)
    echo "[info] starting autodeploy $(date)" > $LOGFILE 2>&1
    cd $AUTODEPLOY || {
        echo "could not cd to $AUTODEPLOY" 1>&2
        exit 1
    }
    ./bin/autodeploy_release foreground >> $LOGFILE 2>&1 &
    echo $! > $PIDFILE
    exit 0
    ;;

  stop)
    echo "[info] stopping autodeploy $(date)" >> $LOGFILE 2>&1
    cd $AUTODEPLOY || {
        echo "could not cd to $AUTODEPLOY" 1>&2
        exit 1
    }
    ./bin/autodeploy_release stop >> $LOGFILE 2>&1
    rm -f $PIDFILE
    exit 0
    ;;

  *)
    echo "Usage: autodeploy-ctl {start|stop}"
    exit 1
    ;;
esac

