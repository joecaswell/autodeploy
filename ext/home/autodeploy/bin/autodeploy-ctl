#!/usr/bin/env bash

if [[ $(whoami) != 'root' ]]
then
  echo "[error] must be started as root user $(id)" 1>&2
  exit 1
fi

export HOME=/home/autodeploy
export AUTODEPLOY=/home/autodeploy/autodeploy

cd $HOME || {
  echo "could not cd to $HOME" 1>&2
  exit 1
}

PIDFILE=/var/run/autodeploy/autodeploy.pid
LOGFILE=/var/log/autodeploy/autodeploy.log

case $1 in
  start)
    echo "[info] starting autodeploy $(date)" > $LOGFILE 2>&1
    su -c "$AUTODEPLOY/bin/autodeploy_release start" autodeploy >> $LOGFILE 2>&1
    escript="$AUTODEPLOY/erts-6.1/bin/escript"
    nodetool="$AUTODEPLOY/bin/nodetool"
    autodeploy_pid=$("$escript" "$nodetool" -name autodeploy@127.0.0.1 -setcookie autodeploy rpcterms os getpid '' | sed -e's/"//g')
    echo $autodeploy_pid > $PIDFILE
    exit 0
    ;;

  stop)
    echo "[info] stopping autodeploy $(date)" >> $LOGFILE 2>&1
    su -c "$AUTODEPLOY/bin/autodeploy_release stop" autodeploy >> $LOGFILE 2>&1
    rm -f $PIDFILE
    exit 0
    ;;

  *)
    echo "Usage: autodeploy-ctl {start|stop}"
    exit 1
    ;;
esac

